---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import RightSidebar from '../components/RightSidebar.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout title="Minis | BeyondMeBtw">
    <Fragment slot="head">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </Fragment>
    <Header />
    <div class="main-container">
        <div class="content-section">
            <div id="activeFilter" class="active-filter" style="display:none;">
                <span id="filterLabel"></span>
                <button class="clear-filter" id="clearFilter">Clear</button>
            </div>
            <div id="postsContainer"></div>
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner" id="loadingSpinner"></div>
                <button class="load-more-btn" id="loadMoreBtn" style="display:none;">Load More</button>
                <div class="no-results" id="noResults" style="display:none;">
                    <h3>No minis found</h3>
                    <p>Check back soon for new content!</p>
                </div>
            </div>
        </div>
        <RightSidebar />
    </div>
    <div class="about-mobile">
        <div class="about-section">
            <h2>What is Minis?</h2>
            <p><strong>MINIS</strong> is my space for short posts like quick thoughts, updates, and ideas that don't need a full blog. It's a casual way to share more often, without writing long essays.</p>
        </div>
    </div>
    <Footer />

    <button class="scroll-to-top" id="scrollToTop">
        <i class="fas fa-arrow-up"></i>
    </button>
</BaseLayout>

<style>
.scroll-to-top {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #3b342d;
    color: #F4F2EF;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(100px);
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.scroll-to-top.visible {
    opacity: 1;
    transform: translateY(0);
}

.scroll-to-top:hover {
    background-color: #5a4c3e;
    transform: translateY(-5px);
}


</style>

<script is:inline>
(function() {
    var METADATA_URL = 'https://minis.beyondmebtw.com/content/metadata.json';
    var FEATURED_URL = '/data/featured_categories.json';
    var POSTS_PER_PAGE = 4;

    var allPosts = [];
    var postsById = {};
    var filteredPosts = [];
    var displayedCount = 0;
    var activeTag = null;
    var searchQuery = '';
    var isCollapsed = false;

    var postsContainer = document.getElementById('postsContainer');
    var loadingSpinner = document.getElementById('loadingSpinner');
    var loadMoreBtn = document.getElementById('loadMoreBtn');
    var noResults = document.getElementById('noResults');
    var searchInput = document.getElementById('searchInput');
    var activeFilterEl = document.getElementById('activeFilter');
    var filterLabel = document.getElementById('filterLabel');
    var clearFilter = document.getElementById('clearFilter');

    // --- Init ---
    async function init() {
        await loadMetadata();
        buildTagCloud();
        loadFeaturedCategories();
        readUrlParams();
        applyFilters();
        renderPosts();
        setupSearch();
        setupTagCloud();
        setupClearFilter();
        setupInfiniteScroll();
        setupCollapseToggle();
        setupScrollToTop();
    }

    async function loadMetadata() {
        try {
            var res = await fetch(METADATA_URL);
            if (!res.ok) throw new Error('Failed to fetch metadata');
            allPosts = await res.json();
        } catch (err) {
            console.error('Error loading metadata:', err);
            try {
                var res2 = await fetch('/content/metadata.json');
                if (res2.ok) allPosts = await res2.json();
            } catch (e) { /* ignore */ }
        }
        allPosts.forEach(function(p) { postsById[p.id] = p; });
        loadingSpinner.style.display = 'none';
    }

    // --- Runtime Tag Cloud ---
    function buildTagCloud() {
        var tagCounts = {};
        allPosts.forEach(function(p) {
            (p.tags || []).forEach(function(t) {
                tagCounts[t] = (tagCounts[t] || 0) + 1;
            });
        });

        var sorted = Object.entries(tagCounts).sort(function(a, b) { return b[1] - a[1]; });
        var container = document.getElementById('tagCloud');
        if (!container) return;

        container.innerHTML = '';

        if (sorted.length === 0) {
            container.closest('.tag-cloud-section').style.display = 'none';
            return;
        }

        sorted.forEach(function(entry, i) {
            var btn = document.createElement('button');
            btn.className = 'tag-cloud-item' + (i >= 3 ? ' tag-overflow' : '');
            btn.setAttribute('data-tag', entry[0]);
            btn.innerHTML = escapeHtml(entry[0]) + ' <span class="tag-count">(' + entry[1] + ')</span>';
            container.appendChild(btn);
        });

        // Mobile toggle for tags (shows top 3, rest hidden on mobile)
        if (sorted.length > 3) {
            var section = container.closest('.tag-cloud-section');
            var toggle = document.createElement('button');
            toggle.className = 'tag-toggle';
            toggle.textContent = 'Show all tags (' + sorted.length + ')';
            toggle.addEventListener('click', function() {
                container.classList.toggle('expanded');
                if (container.classList.contains('expanded')) {
                    toggle.textContent = 'Show less';
                } else {
                    toggle.textContent = 'Show all tags (' + sorted.length + ')';
                }
            });
            section.appendChild(toggle);
        }
    }

    // --- Featured Categories ---
    async function loadFeaturedCategories() {
        try {
            var res = await fetch(FEATURED_URL);
            if (!res.ok) return;
            var categories = await res.json();
            if (!categories || categories.length === 0) return;

            var section = document.getElementById('featuredCategories');
            var list = document.getElementById('featuredList');
            if (!section || !list) return;

            list.innerHTML = '';
            categories.forEach(function(cat) {
                var item = document.createElement('a');
                item.className = 'featured-category-item';
                item.href = '/?tag=' + encodeURIComponent(cat.tag);
                item.textContent = cat.name;
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    setTagFilter(cat.tag);
                });
                list.appendChild(item);
            });

            section.style.display = 'block';
        } catch (e) {
            // Featured categories file missing - section stays hidden
        }
    }

    function readUrlParams() {
        var params = new URLSearchParams(window.location.search);
        if (params.has('tag')) {
            activeTag = params.get('tag');
            var tagBtn = document.querySelector('.tag-cloud-item[data-tag="' + activeTag + '"]');
            if (tagBtn) tagBtn.classList.add('active');
            var tagClearBtn = document.getElementById('tagClearBtn');
            if (tagClearBtn) tagClearBtn.style.display = 'inline-block';
        }
        if (params.has('q')) {
            searchQuery = params.get('q');
            if (searchInput) searchInput.value = searchQuery;
        }
    }

    // --- Filtering ---
    function applyFilters() {
        filteredPosts = allPosts;

        if (activeTag) {
            filteredPosts = filteredPosts.filter(function(p) {
                return (p.tags || []).indexOf(activeTag) !== -1;
            });
        }

        if (searchQuery) {
            var q = searchQuery.toLowerCase();
            filteredPosts = filteredPosts.filter(function(p) {
                return p.title.toLowerCase().indexOf(q) !== -1 ||
                    (p.rawMarkdown || '').toLowerCase().indexOf(q) !== -1;
            });
        }

        displayedCount = 0;
        postsContainer.innerHTML = '';
        updateFilterBanner();
    }

    function updateFilterBanner() {
        if (searchQuery) {
            activeFilterEl.style.display = 'flex';
            filterLabel.textContent = 'Search: "' + searchQuery + '"';
        } else {
            activeFilterEl.style.display = 'none';
        }
    }

    function updateUrl() {
        var params = new URLSearchParams();
        if (activeTag) params.set('tag', activeTag);
        if (searchQuery) params.set('q', searchQuery);
        var qs = params.toString();
        var newUrl = qs ? window.location.pathname + '?' + qs : window.location.pathname;
        history.pushState(null, '', newUrl);
    }

    // --- Collapse / Expand ---
    function getPreview(rawMarkdown) {
        var plain = (rawMarkdown || '').replace(/[#*_[\]()>`~\-]/g, '').replace(/\n+/g, ' ').trim();
        var words = plain.split(/\s+/).filter(Boolean);
        if (words.length <= 40) return plain;
        return words.slice(0, 40).join(' ') + '...';
    }

    function expandPostContent(div, postId) {
        var post = postsById[postId];
        if (!post) return;
        div.innerHTML = post.content || '';
    }

    function collapsePostContent(div, postId) {
        var post = postsById[postId];
        if (!post) return;
        var preview = getPreview(post.rawMarkdown || '');
        div.innerHTML = '<p>' + escapeHtml(preview) + '</p><button class="read-more-btn">Read more &#8595;</button>';
        div.querySelector('.read-more-btn').addEventListener('click', function() {
            expandPostContent(div, postId);
        });
    }

    function setupCollapseToggle() {
        var btn = document.getElementById('collapseToggleBtn');
        if (!btn) return;
        btn.addEventListener('click', function() {
            isCollapsed = !isCollapsed;
            var icon = document.getElementById('collapseIcon');
            var text = document.getElementById('collapseText');
            if (isCollapsed) {
                if (icon) icon.className = 'fas fa-expand';
                if (text) text.textContent = 'Expand All Posts';
            } else {
                if (icon) icon.className = 'fas fa-compress';
                if (text) text.textContent = 'Collapse All Posts';
            }
            document.querySelectorAll('.mini-post-content[data-post-id]').forEach(function(div) {
                var id = div.getAttribute('data-post-id');
                if (isCollapsed) {
                    collapsePostContent(div, id);
                } else {
                    expandPostContent(div, id);
                }
            });
        });
    }

    // --- Scroll to Top ---
    function setupScrollToTop() {
        var scrollBtn = document.getElementById('scrollToTop');
        if (!scrollBtn) return;
        window.addEventListener('scroll', function() {
            if (window.scrollY > 300) {
                scrollBtn.classList.add('visible');
            } else {
                scrollBtn.classList.remove('visible');
            }
        });
        scrollBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // --- Rendering ---
    function renderPosts() {
        var start = displayedCount;
        var end = Math.min(start + POSTS_PER_PAGE, filteredPosts.length);

        if (filteredPosts.length === 0) {
            noResults.style.display = 'block';
            loadMoreBtn.style.display = 'none';
            return;
        }

        noResults.style.display = 'none';

        var prevDate = start > 0 ? filteredPosts[start - 1].date : null;

        for (var i = start; i < end; i++) {
            var post = filteredPosts[i];
            var isSameDate = post.date === prevDate;

            var container = document.createElement('div');
            container.className = 'mini-post-container' + (isSameDate ? ' same-date' : '');
            container.setAttribute('data-tags', (post.tags || []).join(','));

            var dateStr = new Date(post.date).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            var tagsHtml = (post.tags || []).map(function(t) {
                return '<span class="tag" data-tag="' + escapeHtml(t) + '">' + escapeHtml(t) + '</span>';
            }).join('');

            container.innerHTML =
                (!isSameDate ? '<div class="date-tab">' + dateStr + '</div>' : '') +
                '<div class="mini-post">' +
                    '<h2 class="mini-post-title">' +
                        '<a href="/post/' + post.id + '">' + escapeHtml(post.title) + '</a>' +
                    '</h2>' +
                    '<div class="mini-post-content" data-post-id="' + post.id + '">' + (post.content || '') + '</div>' +
                    '<div class="mini-post-meta">' +
                        '<span class="time-tag">' + post.time + ' IST</span>' +
                        tagsHtml +
                    '</div>' +
                '</div>';

            postsContainer.appendChild(container);

            // Apply collapsed state to newly rendered post
            if (isCollapsed) {
                var contentDiv = container.querySelector('.mini-post-content');
                collapsePostContent(contentDiv, post.id);
            }

            if (i < end - 1) {
                var divider = document.createElement('div');
                divider.className = 'post-divider' + (isSameDate ? ' reduced' : '');
                postsContainer.appendChild(divider);
            }

            prevDate = post.date;
        }

        displayedCount = end;

        // Attach click handlers to inline tags
        var tagEls = postsContainer.querySelectorAll('.mini-post-meta .tag');
        tagEls.forEach(function(tagEl) {
            tagEl.style.cursor = 'pointer';
            tagEl.addEventListener('click', function() {
                setTagFilter(this.getAttribute('data-tag'));
            });
        });

        if (displayedCount < filteredPosts.length) {
            loadMoreBtn.style.display = 'block';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    // --- Search ---
    function setupSearch() {
        if (!searchInput) return;
        var debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function() {
                searchQuery = searchInput.value.trim();
                updateUrl();
                applyFilters();
                renderPosts();
            }, 300);
        });
    }

    // --- Tag Cloud ---
    function setupTagCloud() {
        document.querySelectorAll('.tag-cloud-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tag = this.getAttribute('data-tag');
                if (activeTag === tag) {
                    setTagFilter(null);
                } else {
                    setTagFilter(tag);
                }
            });
        });
    }

    function setTagFilter(tag) {
        activeTag = tag;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.querySelectorAll('.tag-cloud-item').forEach(function(btn) {
            if (btn.getAttribute('data-tag') === activeTag) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        var tagClearBtn = document.getElementById('tagClearBtn');
        if (tagClearBtn) tagClearBtn.style.display = activeTag ? 'inline-block' : 'none';
        updateUrl();
        applyFilters();
        renderPosts();
    }

    // --- Clear Filter ---
    function setupClearFilter() {
        clearFilter.addEventListener('click', function() {
            activeTag = null;
            searchQuery = '';
            if (searchInput) searchInput.value = '';
            var tagClearBtn = document.getElementById('tagClearBtn');
            if (tagClearBtn) tagClearBtn.style.display = 'none';
            document.querySelectorAll('.tag-cloud-item').forEach(function(btn) {
                btn.classList.remove('active');
            });
            updateUrl();
            applyFilters();
            renderPosts();
        });

        var tagClearBtn = document.getElementById('tagClearBtn');
        if (tagClearBtn) {
            tagClearBtn.addEventListener('click', function() {
                setTagFilter(null);
            });
        }
    }

    // --- Infinite Scroll ---
    function setupInfiniteScroll() {
        loadMoreBtn.addEventListener('click', function() { renderPosts(); });

        var observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting && displayedCount < filteredPosts.length) {
                renderPosts();
            }
        }, { rootMargin: '200px' });

        observer.observe(document.getElementById('loadingContainer'));
    }

    // --- Helpers ---
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Start
    init();
})();
</script>
