---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
    const posts = await getCollection('posts');
    return posts.map(post => ({
        params: { id: post.data.id },
        props: { post },
    }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

const siteUrl = "https://minis.beyondmebtw.com";
const postUrl = `${siteUrl}/post/${post.data.id}`;
const publishedTime = `${post.data.date}T${post.data.time}:00+05:30`;

// Get first 160 chars of content for description (strip markdown)
const rawText = post.body?.replace(/[#*_\[\]()>`~-]/g, '').replace(/\n+/g, ' ').trim() || '';
const description = rawText.substring(0, 160) + (rawText.length > 160 ? '...' : '');

const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "datePublished": publishedTime,
    "url": postUrl,
    "author": {
        "@type": "Person",
        "name": "Pranav Veeraghanta",
        "url": "https://beyondmebtw.com/about"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Beyond Me Btw",
        "url": "https://beyondmebtw.com"
    },
    "keywords": post.data.tags.join(', ')
};
---

<BaseLayout
    title={`${post.data.title} | Minis`}
    description={description}
    ogTitle={post.data.title}
    ogType="article"
    publishedTime={publishedTime}
    canonicalUrl={postUrl}
>
    <Fragment slot="head">
        {post.data.tags.map(tag => (
            <meta property="article:tag" content={tag} />
        ))}
        <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    </Fragment>

    <Header />
    <main class="post-page">
        <article>
            <header class="post-header">
                <div class="post-date">
                    <time datetime={post.data.date}>{formattedDate}</time> at {post.data.time} IST
                </div>
                <h1>{post.data.title}</h1>
                <div class="post-tags">
                    {post.data.tags.map(tag => (
                        <a href={`/?tag=${tag}`} class="tag">{tag}</a>
                    ))}
                </div>
            </header>
            <div class="post-content">
                <Content />
            </div>
        </article>
        <a href="/" class="back-link">&larr; Back to all minis</a>
    </main>
    <Footer />
</BaseLayout>
